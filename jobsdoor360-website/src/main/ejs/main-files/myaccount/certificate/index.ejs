<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Certificate</title>
    <meta
      name="description"
      content="Certificate by JobsDoor360:  Learn Full Stack, Java, and Web Development. Advance Your Career with Industry Professionals. Gain In-Demand Skills for Software Jobs. Practice Interviews and Perfect Your CV"
    />
    <link rel="stylesheet" href="style.css" />
    <!--<link rel="stylesheet" href="/staticfiles/mainfiles/myaccount/certificate/style.css" />-->
    <link
      href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <%- include('../../../partials/head.ejs') %>
  </head>

  <body>
    <%- include('../../../partials/navbar.ejs') %>

    <button id="btn" class="btn">Download Certificate</button>
    <br>

    <div id="pdfContent">
      <div id="certificate" role="document" aria-label="Certificate of Completion">
        <div class="badge">DSA QUIZ</div>

        <div class="title">
          <h1>Certificate of Completion</h1>
          <p>This certificate is proudly presented to</p>
        </div>

        <div class="content">
          <div class="recipient" id="cert-name">[Participant Name]</div>
          <div class="desc" id="cert-desc">
            For successfully passing the <strong>Data Structures & Algorithms (DSA)</strong> quiz with outstanding performance.
          </div>

          <div class="meta" aria-hidden="false">
            <div class="box">
              <label>Score</label>
              <div class="value" id="cert-score">95%</div>
            </div>

            <div class="box">
              <label>Quiz</label>
              <div class="value" id="cert-quiz">DSA Fundamentals — Quiz #3</div>
            </div>

            <div class="box">
              <label>Date</label>
              <div class="value" id="cert-date">Nov 20, 2025</div>
            </div>

            <div class="box">
              <label>Duration</label>
              <div class="value" id="cert-duration">30 minutes</div>
            </div>
          </div>

          <div class="footer">
            <div class="issuer">
              <img src="https://via.placeholder.com/56x56.png?text=Logo" alt="Issuer logo" />
              <div class="info">
                <div class="org">Jobsdoor360 Academy</div>
                <div class="small">Verified by the DSA assessment team</div>
              </div>
            </div>

            <div class="signatures" aria-hidden="true">
              <div class="sign">
                <div class="line"></div>
                <div class="name">Shivpriya Gaur</div>
                <div class="role">Course Lead</div>
              </div>

              <div class="sign">
                <div class="line"></div>
                <div class="name">Vinod Gaur</div>
                <div class="role">Head — Assessments</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('../../../partials/footer.ejs') %>
    
    <!-- libs -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      async function getData() {
          const params = new URLSearchParams(window.location.search);
          let data = await decryptData(params.get('data'));
          return JSON.parse(data);
      }

      getData().then(data => {
          let name = getLoggedInUserName();

          console.log(data, name);
      });

      
    document.getElementById('btn').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;

      const element = document.getElementById('pdfContent');

      // Ensure element is fully visible/rendered
      element.style.background = 'white';

      // 1) Render element to canvas with html2canvas
      const canvas = await html2canvas(element, {
        scale: 2,              // increase for better quality
        useCORS: true,         // allow cross-origin images if served with CORS
        allowTaint: false,
        logging: false
      });

      // 2) Prepare jsPDF A4
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pdfWidthMM = pdf.internal.pageSize.getWidth();
      const pdfHeightMM = pdf.internal.pageSize.getHeight();

      // Convert canvas size into PDF units
      const imgWidthPx = canvas.width;
      const imgHeightPx = canvas.height;
      const pxPerMm = imgWidthPx / pdfWidthMM;          // number of canvas px per mm of PDF width
      const pageHeightPx = Math.floor(pdfHeightMM * pxPerMm); // page height in canvas px

      // 3) Slice the canvas into page-sized chunks
      let y = 0;
      while (y < imgHeightPx) {
        const canvasSlice = document.createElement('canvas');
        canvasSlice.width = imgWidthPx;
        // sliceHeightPx: remaining or pageHeightPx
        const sliceHeightPx = Math.min(pageHeightPx, imgHeightPx - y);
        canvasSlice.height = sliceHeightPx;

        const ctx = canvasSlice.getContext('2d');
        // draw the slice from the original canvas into the temp canvas
        ctx.drawImage(canvas, 0, y, imgWidthPx, sliceHeightPx, 0, 0, imgWidthPx, sliceHeightPx);

        // convert slice to image data
        const imgData = canvasSlice.toDataURL('image/png');

        // compute slice height in mm for jsPDF
        const sliceHeightMM = sliceHeightPx / pxPerMm;

        // Add image to PDF — full width, computed height
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidthMM, sliceHeightMM, undefined, 'FAST');

        y += sliceHeightPx;
        if (y < imgHeightPx) pdf.addPage();
      }

      // 4) Save the PDF
      pdf.save('generated_document.pdf');
    });
    </script>
  </body>
</html>
